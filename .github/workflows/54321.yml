name: Patch Init_Boot for S24 Bypass
on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Script
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget cpio

      - name: Get Magisk v30.6 and Extract magiskboot and get init_boot
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 4. 获得init_boot.img
          gh release download init --repo ${{ github.repository }} --clobber
          
          # 1. 下载官方 Magisk v30.6 APK (2026年最新稳定版)
          echo "正在下载 Magisk v30.6..."
          wget https://github.com/topjohnwu/Magisk/releases/download/v30.6/Magisk-v30.6.apk
          
          # 2. 提取适用于 Linux 虚拟机的 magiskboot 二进制文件
          # Magisk APK 本质是 ZIP，lib/x86_64 目录下包含可在 GitHub Actions 运行的工具
          unzip -q Magisk-v30.6.apk "lib/x86_64/libmagiskboot.so"
          
          # 3. 重命名并赋予权限
          mv lib/x86_64/libmagiskboot.so ./magiskboot
          chmod +x magiskboot
          
          # 验证工具是否可用
          ./magiskboot --help | head -n 1



      - name: Patch Ramdisk
        run: |
          # 1. 解包官方 init_boot
          ./magiskboot unpack init_boot.img
          
          # 2. 批量修改 ramdisk 内部属性 (核心：禁用联网要求并开启 ADB)
          # 使用 magiskboot 的 patch 功能可以一次性处理多个 prop 文件
          ./magiskboot cpio ramdisk "patch" \
            "ro.debuggable 0 1" \
            "ro.adb.secure 1 0" \
            "ro.secure 1 0" \
            "ro.setupwizard.mode ENABLED DISABLED" \
            "ro.setupwizard.network_required 1 0" \
            "ro.setupwizard.wifi_required 1 0"

          # 3. 创建跳过激活的脚本
          cat <<EOF > skip_wizard.rc
          on early-init
              setprop ro.debuggable 1
              setprop ro.adb.secure 0
              setprop ro.secure 0
              setprop sys.usb.config adb
              setprop sys.usb.configfs 1

          on post-fs-data
              setprop ro.setupwizard.mode DISABLED
              exec /system/bin/settings put global device_provisioned 1
              exec /system/bin/settings put secure user_setup_complete 1

              exec /system/bin/pm disable-user com.sec.android.app.setupwizard
              exec /system/bin/pm disable-user com.google.android.setupwizard
          EOF


          
          # 4. 将脚本加入 ramdisk
          ./magiskboot cpio ramdisk "add 0750 skip_wizard.rc skip_wizard.rc"
          
          # 5. 重包 init_boot
          ./magiskboot repack init_boot.img init_boot_patched.img
          
          # 6. 【关键】强制对齐回原始大小 8192KB (8,388,608 字节)
          # 这样做是为了确保分区的物理一致性，避开三星的哈希校验异常
          truncate -s 8192K init_boot_patched.img

      - name: Upload Patched Image
        uses: actions/upload-artifact@v4
        with:
          name: S24-Bypass-InitBoot
          path: init_boot_patched.img
